"use strict";(self.webpackChunkink_docs=self.webpackChunkink_docs||[]).push([[8387],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},p="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(n),d=o,m=p["".concat(l,".").concat(d)]||p[d]||h[d]||i;return n?a.createElement(m,r(r({ref:t},u),{},{components:n})):a.createElement(m,r({ref:t},u))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[p]="string"==typeof e?e:o,r[1]=s;for(var c=2;c<i;c++)r[c]=n[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},68738:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var a=n(87462),o=(n(67294),n(3905));const i={title:"Contract Testing",hide_title:!0,slug:"/basics/contract-testing"},r=void 0,s={unversionedId:"basics/testing",id:"basics/testing",title:"Contract Testing",description:"ink! supports three different stages of testing: unit, integration",source:"@site/docs/basics/testing.md",sourceDirName:"basics",slug:"/basics/contract-testing",permalink:"/basics/contract-testing",draft:!1,editUrl:"https://github.com/paritytech/ink-docs/edit/master/docs/basics/testing.md",tags:[],version:"current",frontMatter:{title:"Contract Testing",hide_title:!0,slug:"/basics/contract-testing"},sidebar:"reference",previous:{title:"Metadata",permalink:"/basics/metadata"},next:{title:"Contract Debugging",permalink:"/basics/contract-debugging"}},l={},c=[{value:"Unit Tests",id:"unit-tests",level:2},{value:"Off-chain Tests",id:"off-chain-tests",level:2},{value:"How do you find out if your test requires the off-chain environment?",id:"how-do-you-find-out-if-your-test-requires-the-off-chain-environment",level:3},{value:"Example",id:"example",level:3},{value:"End-to-End (E2E) Tests",id:"end-to-end-e2e-tests",level:2},{value:"Example",id:"example-1",level:3},{value:"End-to-End (E2E) testing of ink! contracts off of live chain state",id:"end-to-end-e2e-testing-of-ink-contracts-off-of-live-chain-state",level:2},{value:"Run a node",id:"run-a-node",level:3},{value:"Setup chopsticks",id:"setup-chopsticks",level:3},{value:"Run ink! e2e tests",id:"run-ink-e2e-tests",level:3}],u={toc:c},p="wrapper";function h(e){let{components:t,...n}=e;return(0,o.kt)(p,(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("img",{src:"/img/title/testing1.svg",className:"titlePic"}),(0,o.kt)("h1",{id:"contract-testing"},"Contract Testing"),(0,o.kt)("p",null,"ink! supports three different stages of testing: unit, integration\nand end-to-end tests. On this page we'll explain what the purpose\nof each stage is about and how to use it."),(0,o.kt)("img",{src:"/img/testing.png"}),(0,o.kt)("p",null,"Generally you can think of those three types of testing as a pyramid\nwith the top being the most elaborate test. The End-to-End (E2E)\ntests at the top will test the lower layers of the pyramid as part\nof them."),(0,o.kt)("h2",{id:"unit-tests"},"Unit Tests"),(0,o.kt)("p",null,"Testing contracts off-chain is done by ",(0,o.kt)("inlineCode",{parentName:"p"},"cargo test")," and users can simply use the standard Rust\nroutines of creating unit test modules within the ink! project:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn my_test() { ... }\n}\n")),(0,o.kt)("p",null,"Test instances of contracts can be created with something like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"let contract = MyContract::my_constructor(a, b);\n")),(0,o.kt)("p",null,"Messages can simply be called on the returned instance as if ",(0,o.kt)("inlineCode",{parentName:"p"},"MyContract::my_constructor")," returns a\n",(0,o.kt)("inlineCode",{parentName:"p"},"Self")," instance."),(0,o.kt)("p",null,"See the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/paritytech/ink-examples/blob/main/flipper/lib.rs"},"flipper example"),"."),(0,o.kt)("h2",{id:"off-chain-tests"},"Off-chain Tests"),(0,o.kt)("p",null,"For integration tests, the test is annotated with our ",(0,o.kt)("inlineCode",{parentName:"p"},"#[ink::test]"),"\nattribute instead of ",(0,o.kt)("inlineCode",{parentName:"p"},"#[test]"),". Our attribute denotes that\nthe test is then executed in a simulated, mocked blockchain environment.\nhere are functions available to influence how the test environment\nis configured (e.g. setting a specified balance of an account to\nsimulate how a contract would behave when interacting with it)."),(0,o.kt)("p",null,"If you annotate a test with the ",(0,o.kt)("inlineCode",{parentName:"p"},"#[ink::test]")," attribute it\nwill be executed in a simulated environment, similar to as it\nwould be run on-chain.\nYou then have fine-grained control over how a contract is called;\nfor example you can influence the block advancement, the value transferred to it,\nby which account it is called, which storage it is run with, etc.."),(0,o.kt)("p",null,"See the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/paritytech/ink-examples/blob/main/erc20/lib.rs"},(0,o.kt)("inlineCode",{parentName:"a"},"examples/erc20"))," contract on how to utilize those or ",(0,o.kt)("a",{parentName:"p",href:"https://docs.rs/ink/4.0.0/ink/attr.test.html"},"the documentation")," for details."),(0,o.kt)("p",null,"At the moment there are some known limitations to our off-chain environment,\nand we are working on making it behave as close to the real chain environment\nas possible."),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"One limitation of the off-chain testing framework is that it\ncurrently only supports a ",(0,o.kt)("inlineCode",{parentName:"p"},"DefaultEnvironment"),"."),(0,o.kt)("p",{parentName:"admonition"},"See ",(0,o.kt)("a",{parentName:"p",href:"/basics/chain-environment-types"},"here")," for an explanation of what an environment is.")),(0,o.kt)("h3",{id:"how-do-you-find-out-if-your-test-requires-the-off-chain-environment"},"How do you find out if your test requires the off-chain environment?"),(0,o.kt)("p",null,"Normally if the test recursively uses or invokes some contract methods that\ncall a method defined in ",(0,o.kt)("inlineCode",{parentName:"p"},"self.env()")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"Self::env()"),"."),(0,o.kt)("p",null,"An example is the following:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"let caller: AccountId = self.env().caller();\n")),(0,o.kt)("h3",{id:"example"},"Example"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"#[cfg(test)]\nmod tests {\n    // Conventional unit test that works with assertions.\n    #[ink::test]\n    fn test1() {\n        // test code comes here as usual\n    }\n\n    // Conventional unit test that returns some Result.\n    // The test code can make use of operator-`?`.\n    #[ink::test]\n    fn test2() -> Result<(), ink::env::Error> {\n        // test code that returns a Rust Result type\n    }\n}\n")),(0,o.kt)("h2",{id:"end-to-end-e2e-tests"},"End-to-End (E2E) Tests"),(0,o.kt)("p",null,"E2E testing enables developers to write a test that will not only test the contract in an\nisolated manner; instead the contract will be tested ",(0,o.kt)("em",{parentName:"p"},"together")," with all components that\nwill be involved on-chain \u2013 so from end to end. This way of testing resembles closely\nhow the contract will actually behave in production."),(0,o.kt)("p",null,"As part of the test, the contract will be compiled and deployed to a Substrate node that\nis running in the background. ink! offers API functions that enable developers to then\ninteract with the contract via transactions that they create and submit to the blockchain."),(0,o.kt)("p",null,"You as a developer can define assertions on the outcome of their transactions, such as checking\nfor state mutations, transaction failures or incurred gas costs."),(0,o.kt)("p",null,"Your chain configuration will be tested together with the smart contract. And if your\nchain has pallets that are involved with the smart contract execution, those will be\npart of the test execution as well."),(0,o.kt)("p",null,"ink! does not put any requirements on the Substrate node in the background \u2013 for example,\nyou can run a node that contains a snapshot of a live network."),(0,o.kt)("h3",{id:"example-1"},"Example"),(0,o.kt)("p",null,"The following code example illustrates a basic E2E test for the\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/paritytech/ink-examples/blob/main/flipper/lib.rs"},"flipper example"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},'#[ink_e2e::test]\nasync fn default_works(mut client: ink_e2e::Client<C, E>) -> E2EResult<()> {\n    // When the function is entered, the contract was already\n    // built in the background via `cargo contract build`.\n    // The `client` object exposes an interface to interact\n    // with the Substrate node.\n    \n    // given\n    let constructor = FlipperRef::new_default();\n\n    // when\n    let contract_acc_id = client\n        .instantiate("flipper", &ink_e2e::bob(), constructor, 0, None)\n        .await\n        .expect("instantiate failed")\n        .account_id;\n\n    // then\n    let get = build_message::<FlipperRef>(contract_acc_id.clone())\n        .call(|flipper| flipper.get());\n    let get_res = client\n        .call(&ink_e2e::bob(), get, 0, None)\n        .await\n        .expect("get failed");\n    assert!(matches!(get_res.return_value(), false));\n\n    Ok(())\n}\n')),(0,o.kt)("p",null,"You can run the above test by going to the ",(0,o.kt)("inlineCode",{parentName:"p"},"flipper")," folder in\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/paritytech/ink-examples/tree/main"},"the ink! examples directory"),"."),(0,o.kt)("p",null,"Before you can run the test, you have to install a Substrate\nnode with ",(0,o.kt)("inlineCode",{parentName:"p"},"pallet-contracts"),". By default e2e tests require that you install ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/paritytech/substrate-contracts-node"},(0,o.kt)("inlineCode",{parentName:"a"},"substrate-contracts-node")),". You do not need to run it in the background since the node is started for each test independently.\nTo install the latest version:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"cargo install contracts-node --git https://github.com/paritytech/substrate-contracts-node.git\n")),(0,o.kt)("p",null,"If you want to run any other node with ",(0,o.kt)("inlineCode",{parentName:"p"},"pallet-contracts")," you need to change ",(0,o.kt)("inlineCode",{parentName:"p"},"CONTRACTS_NODE")," environment variable:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'export CONTRACTS_NODE="YOUR_CONTRACTS_NODE_PATH"\n')),(0,o.kt)("p",null,"And finally execute the following command to start e2e test execution."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"cargo test --features e2e-tests\n")),(0,o.kt)("h2",{id:"end-to-end-e2e-testing-of-ink-contracts-off-of-live-chain-state"},"End-to-End (E2E) testing of ink! contracts off of live chain state"),(0,o.kt)("h3",{id:"run-a-node"},"Run a node"),(0,o.kt)("p",null,"In a real world case you will already have a live node. This will be the node you want to test you contracts off of. For example purposes we will be running a ",(0,o.kt)("inlineCode",{parentName:"p"},"substrate-contracts-node"),". "),(0,o.kt)("p",null,"Clone substrate-contracts-node:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"git clone https://github.com/paritytech/substrate-contracts-node\n")),(0,o.kt)("p",null,"Compile and run it:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"cargo build\n./target/debug/substrate-contracts-node\n")),(0,o.kt)("p",null,"You should get output similar to:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},' % ./target/debug/substrate-contracts-node\n2023-09-26 07:58:28.885  INFO main sc_cli::runner: Substrate Contracts Node    \n2023-09-26 07:58:28.887  INFO main sc_cli::runner: \u270c\ufe0f  version 0.30.0-124c159ba94    \n2023-09-26 07:58:28.887  INFO main sc_cli::runner: \u2764\ufe0f  by Parity Technologies <admin@parity.io>, 2021-2023    \n2023-09-26 07:58:28.887  INFO main sc_cli::runner: \ud83d\udccb Chain specification: Development    \n2023-09-26 07:58:28.887  INFO main sc_cli::runner: \ud83c\udff7  Node name: chilly-desire-6458    \n2023-09-26 07:58:28.887  INFO main sc_cli::runner: \ud83d\udc64 Role: AUTHORITY    \n2023-09-26 07:58:28.887  INFO main sc_cli::runner: \ud83d\udcbe Database: ParityDb at /tmp/substrateoKCAts/chains/dev/paritydb/full    \n2023-09-26 07:58:38.723  INFO main sc_rpc_server: Running JSON-RPC server: addr=127.0.0.1:9944, allowed origins=["*"]  \n')),(0,o.kt)("p",null,"Next, produce one or two blocks by running ",(0,o.kt)("inlineCode",{parentName:"p"},"system.remark()")," extrinsics. You can use the PolkadotJs Apps to do this. This is so we have 1 or 2 blocks produced on the node for the next step."),(0,o.kt)("h3",{id:"setup-chopsticks"},"Setup ",(0,o.kt)("a",{parentName:"h3",href:"https://github.com/AcalaNetwork/chopsticks"},"chopsticks")),(0,o.kt)("p",null,"Chopsticks is a powerful tool in our ecosystem that will allow us to mirror a running node. We will run chopsticks and have it mirror the substrate-contracts-node that is already running on our machince from the previous step. This will allow us to have a node with live chain state to test our contracts off of."),(0,o.kt)("p",null,"Clone chopsticks:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"git clone https://github.com/AcalaNetwork/chopsticks\n")),(0,o.kt)("p",null,"Modify the dev.yml config file in the repo or create one from scratch that you can reference later:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"endpoint: ws://127.0.0.1:9944\nmock-signature-host: true\nblock: 1\ndb: ./db.sqlite\n")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Note: In the example above chopsticks will be mirroring up until block 1 from the substrate-contracts-node. For real world use case you would want to use a different block number and this is the place where you can configure other variables such as a sudo key. Read the chopsticks docs for more info.")),(0,o.kt)("p",null,"You can either run chopsticks locally by following the instructions here:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/AcalaNetwork/chopsticks#install"},"https://github.com/AcalaNetwork/chopsticks#install"))),(0,o.kt)("p",null,"Or you can run chopsticks using npx:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"npx @acala-network/chopsticks@latest --config=configs/dev.yml\n")),(0,o.kt)("p",null,"You should get output similar to:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"npx @acala-network/chopsticks@latest --config=configs/dev.yml\n[08:22:31.231] INFO (rpc/3037748): Development RPC listening on port 8000\n")),(0,o.kt)("p",null,"Recap: We have our live node running on port 9944 and our test node running on port 8000."),(0,o.kt)("h3",{id:"run-ink-e2e-tests"},"Run ink! e2e tests"),(0,o.kt)("p",null,"Next we would like to run the integration tests for our ink! smart contract. For example purposes we will use the flipper ink! integration tests which reside in the ink! repo."),(0,o.kt)("p",null,"Let's get started, clone ink!:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"git clone https://github.com/paritytech/ink\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"cd")," into ",(0,o.kt)("inlineCode",{parentName:"p"},"integration-tests/flipper"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"cd integration-tests/flipper\n")),(0,o.kt)("p",null,"Let's now run our flipper integration tests against the chopsticks node (which has the live chain state):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"CONTRACTS_NODE=/home/bruno/src/substrate-contracts-node/target/debug/substrate-contracts-node WS_PORT=8000 cargo test --features e2e-tests\n")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Notice how we use the ",(0,o.kt)("inlineCode",{parentName:"p"},"CONTRACTS_NODE")," environment variable to specify where our chopsticks node is running. This is essential.")),(0,o.kt)("p",null,"You will get output similar to the following:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"running 4 tests\ntest flipper::tests::it_works ... ok\ntest flipper::tests::default_works ... ok\ntest flipper::e2e_tests::default_works ... ok\ntest flipper::e2e_tests::it_works ... ok\n\ntest result: ok. 4 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 1.29s\n\n   Doc-tests flipper\n\nrunning 0 tests\n\ntest result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n")),(0,o.kt)("p",null,"Success! We just ran ink! integration tests against live chain state!"))}h.isMDXComponent=!0}}]);